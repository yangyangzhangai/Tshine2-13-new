# Time Shine - æŠ€æœ¯æ¶æ„æ–‡æ¡£

> ç³»ç»Ÿæ¶æ„ã€æ•°æ®æµä¸æ ¸å¿ƒç®—æ³•

---

## ğŸ“‹ æ–‡æ¡£è¯´æ˜

- **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
- **æœ€åæ›´æ–°**ï¼š2026-02-15
- **å…³è”æ–‡æ¡£**ï¼šPROJECT_OVERVIEW.mdã€REQUIREMENTS.mdã€AI_DESIGN.md

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Time Shine                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Chat Page  â”‚  â”‚   Todo Page  â”‚  â”‚ Gallery Page â”‚  â”‚ Report Page â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                 â”‚                  â”‚                 â”‚        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”‚                         Store Layer                                   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â”‚ChatStore â”‚ â”‚TodoStore â”‚ â”‚Fragment  â”‚ â”‚Annotationâ”‚ â”‚ Gallery  â”‚   â”‚
â”‚  â”‚  â”‚          â”‚ â”‚          â”‚ â”‚  Store   â”‚ â”‚  Store   â”‚ â”‚  Store   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚          â”‚            â”‚            â”‚            â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Service Layer                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚  AI        â”‚ â”‚  Fragment  â”‚ â”‚  Glass     â”‚ â”‚  Shadow    â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  Annotator â”‚ â”‚  Generator â”‚ â”‚  Generator â”‚ â”‚  Diary     â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚              â”‚              â”‚              â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           API Layer                            â”‚   â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚   â”‚
â”‚  â”‚              â”‚      AI Service (User API)      â”‚               â”‚   â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ æ ¸å¿ƒæ•°æ®æµ

### 1. æ´»åŠ¨è®°å½• â†’ ç¢ç‰‡ç”Ÿæˆ

```
ç”¨æˆ·åœ¨ ChatPage è®°å½•æ´»åŠ¨
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ChatStore.     â”‚
â”‚   sendMessage()  â”‚  (Record Mode)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Message Created â”‚  duration calculated
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FragmentStore.   â”‚
â”‚ addPending()     â”‚  Queue for AI processing
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ (Real-time)          â”‚ (Batch)
         â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Immediate      â”‚    â”‚  Scheduled Job  â”‚
â”‚  AI Call        â”‚    â”‚  (End of Day)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚
         â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Single Fragmentâ”‚    â”‚  Batch Generate â”‚
â”‚  Generated      â”‚    â”‚  All Fragments  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  AI Returns:         â”‚
         â”‚  shape, color,       â”‚
         â”‚  texture, temp       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  FragmentStore.      â”‚
         â”‚  updateFragment()    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Trigger:            â”‚
         â”‚  Fragment Animation  â”‚
         â”‚  in Gallery          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. äº‹ä»¶è§¦å‘ â†’ AI æ‰¹æ³¨

```
ç”¨æˆ·è¡Œä¸º
    â”‚
    â”œâ”€â–º å®Œæˆæ´»åŠ¨
    â”œâ”€â–º åˆ é™¤å¾…åŠ
    â”œâ”€â–º 3å°æ—¶æ— æ“ä½œ
    â””â”€â–º ...
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Event Emitter   â”‚  Central event bus
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIAnnotator.    â”‚
â”‚  onEvent()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     No      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Check Cooldown? â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Skip   â”‚
â”‚  Check Limit?    â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     Yes
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Calculate       â”‚
â”‚  Probability     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     No      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Random < Prob?  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   Skip   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     Yes     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Call AI API     â”‚
â”‚  Generate Text   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AnnotationStore â”‚
â”‚  addAnnotation() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI: Show Bubble â”‚
â”‚  8s animation    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. æ—¥ç»ˆæµç¨‹ â†’ å½©çª—ç”Ÿæˆ

```
Trigger: 23:59 or User Open Gallery
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GalleryStore.   â”‚
â”‚  generateDaily() â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Fetch Today's   â”‚
â”‚  Fragments       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Call AI API:    â”‚
â”‚  "Generate Theme â”‚
â”‚   & Layout"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Returns:     â”‚
â”‚  - themeDesc     â”‚
â”‚  - fragmentPositions[]
â”‚  - summary       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Create          â”‚
â”‚  StainedGlass    â”‚
â”‚  Object          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Generate Shadow â”‚
â”‚  Diary (Async)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Save to Store   â”‚
â”‚  & LocalStorage  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è¯¦è§£

### 1. Fragment Store Schema

```typescript
// store/useFragmentStore.ts

interface FragmentState {
  // æ•°æ®å­˜å‚¨
  fragments: TimeFragment[];
  pendingFragments: string[];  // ç­‰å¾… AI å¤„ç†çš„ messageIds
  
  // å½“æ—¥ç»Ÿè®¡ï¼ˆç”¨äº AI å†³ç­–ï¼‰
  todayStats: {
    date: string;
    totalActivities: number;
    totalDuration: number;
    moodKeywords: string[];
    hourDistribution: number[];  // 24å°æ—¶åˆ†å¸ƒ
  };
  
  // Actions
  addPending: (messageId: string) => void;
  generateFragment: (messageId: string) => Promise<void>;
  batchGenerate: (date: string) => Promise<void>;
  getFragmentsByDate: (date: string) => TimeFragment[];
  getFragmentById: (id: string) => TimeFragment | undefined;
}

// æŒä¹…åŒ–é…ç½®
const persistConfig = {
  name: 'fragment-storage',
  partialize: (state) => ({
    fragments: state.fragments,
    todayStats: state.todayStats
  })
};
```

### 2. Annotation Store Schema

```typescript
// store/useAnnotationStore.ts

interface AnnotationState {
  // å½“å‰æ˜¾ç¤ºçš„æ‰¹æ³¨
  currentAnnotation: AIAnnotation | null;
  
  // ä»Šæ—¥çŠ¶æ€
  todayStats: {
    date: string;
    speakCount: number;
    lastSpeakTime: number;
    events: AnnotationEvent[];  // ä»Šæ—¥äº‹ä»¶æ—¥å¿—
  };
  
  // é…ç½®
  config: {
    dailyLimit: number;      // é»˜è®¤ 5
    cooldownMs: number;      // é»˜è®¤ 7200000 (2å°æ—¶)
    enabled: boolean;        // æ€»å¼€å…³
  };
  
  // Actions
  triggerAnnotation: (event: AnnotationEvent) => Promise<void>;
  dismissAnnotation: () => void;
  resetDailyStats: () => void;
  updateConfig: (config: Partial<AnnotationConfig>) => void;
}

interface AIAnnotation {
  id: string;
  content: string;
  tone: 'playful' | 'concerned' | 'celebrating';
  timestamp: number;
  relatedEvent: AnnotationEvent;
  displayDuration: number;
}
```

### 3. Gallery Store Schema

```typescript
// store/useGalleryStore.ts

interface GalleryState {
  // å½©çª—é›†åˆ
  dailyGlasses: StainedGlass[];
  weeklyGlasses: StainedGlass[];
  monthlyGlasses: StainedGlass[];
  
  // å½“å‰è§†å›¾
  currentView: {
    period: 'daily' | 'weekly' | 'monthly';
    date: string;
  };
  
  // å½±å­æ—¥è®°
  diaries: ShadowDiary[];
  unreadDiaryCount: number;
  
  // ç”ŸæˆçŠ¶æ€
  isGenerating: boolean;
  generationProgress: number;
  
  // Actions
  generateDailyGlass: (date: string) => Promise<void>;
  generateWeeklyGlass: (week: string) => Promise<void>;
  generateMonthlyGlass: (month: string) => Promise<void>;
  generateShadowDiary: (date: string) => Promise<void>;
  markDiaryAsRead: (diaryId: string) => void;
  navigateTo: (period: string, date: string) => void;
}
```

---

## ğŸ§® æ ¸å¿ƒç®—æ³•

### 1. ç¢ç‰‡å¸ƒå±€ç®—æ³• (Daily)

```typescript
// services/glassGenerator.ts

interface LayoutAlgorithm {
  // è¾“å…¥
  fragments: TimeFragment[];
  canvasSize: { width: number; height: number };
  
  // è¾“å‡º
  layouts: FragmentLayout[];
}

function generateDailyLayout(
  fragments: TimeFragment[],
  themeDescription: string  // AI æä¾›çš„ä¸»é¢˜æè¿°
): FragmentLayout[] {
  const layouts: FragmentLayout[] = [];
  const center = { x: 0.5, y: 0.5 };
  
  // æŒ‰æ—¶é—´æ®µåˆ†ç»„
  const groups = groupByTimeOfDay(fragments);
  
  // å¤§ç¢ç‰‡ï¼ˆé•¿æ—¶é—´ï¼‰æ”¾ä¸­å¿ƒ
  const largeFragments = fragments
    .filter(f => f.metadata.duration > 60)
    .sort((a, b) => b.metadata.duration - a.metadata.duration);
  
  largeFragments.forEach((fragment, index) => {
    const angle = (index / largeFragments.length) * Math.PI * 2;
    const radius = 0.1 + Math.random() * 0.1;  // é è¿‘ä¸­å¿ƒ
    
    layouts.push({
      fragmentId: fragment.id,
      position: {
        x: center.x + Math.cos(angle) * radius,
        y: center.y + Math.sin(angle) * radius
      },
      scale: 1.2 + fragment.metadata.duration / 120,  // æ—¶é•¿è¶Šå¤§è¶Šå¤§
      rotation: Math.random() * 30 - 15,
      layer: 1
    });
  });
  
  // å°ç¢ç‰‡èºæ—‹å‘å¤–åˆ†å¸ƒ
  const smallFragments = fragments.filter(f => f.metadata.duration <= 60);
  smallFragments.forEach((fragment, index) => {
    const spiralAngle = index * 0.5;  // é»„é‡‘è§’
    const spiralRadius = 0.2 + index * 0.05;
    
    layouts.push({
      fragmentId: fragment.id,
      position: {
        x: center.x + Math.cos(spiralAngle) * spiralRadius,
        y: center.y + Math.sin(spiralAngle) * spiralRadius
      },
      scale: 0.6 + Math.random() * 0.4,
      rotation: Math.random() * 360,
      layer: 0
    });
  });
  
  return layouts;
}
```

### 2. å‘¨/æœˆæ‹¼å›¾ç®—æ³•

```typescript
function generateWeeklyLayout(
  dailyGlasses: StainedGlass[]
): FragmentLayout[] {
  // å°†æ¯æ—¥å½©çª—è§†ä¸º"è¶…çº§ç¢ç‰‡"
  const superFragments = dailyGlasses.map((glass, index) => ({
    id: glass.id,
    preview: generateThumbnail(glass),  // ç”Ÿæˆç¼©ç•¥å›¾
    dayOfWeek: index
  }));
  
  // èœ‚å·¢å¼å¸ƒå±€
  return superFragments.map((sf, index) => {
    const row = Math.floor(index / 4);
    const col = index % 4;
    const offset = row % 2 === 0 ? 0 : 0.5;  // èœ‚å·¢åç§»
    
    return {
      fragmentId: sf.id,
      position: {
        x: (col + offset) * 0.25,
        y: row * 0.3
      },
      scale: 0.9,
      rotation: (Math.random() - 0.5) * 10,  // è½»å¾®éšæœºæ—‹è½¬
      layer: 0
    };
  });
}
```

### 3. æ¦‚ç‡è®¡ç®—ç®—æ³•

```typescript
// services/aiAnnotator.ts

interface EventWeight {
  base: number;           // åŸºç¡€æ¦‚ç‡ 0-100
  max: number;            // æœ€å¤§æ¦‚ç‡ä¸Šé™
  bonuses: BonusCondition[];
}

interface BonusCondition {
  check: (event: AnnotationEvent, context: UserContext) => boolean;
  bonus: number;          // åŠ æˆå€¼
  description: string;    // ç”¨äºè°ƒè¯•
}

const EVENT_WEIGHTS: Record<string, EventWeight> = {
  activity_completed: {
    base: 30,
    max: 60,
    bonuses: [
      {
        check: (e, c) => e.data.duration > 120,
        bonus: 15,
        description: 'æ·±åº¦å·¥ä½œ (>2h)'
      },
      {
        check: (e, c) => {
          const hour = new Date(e.timestamp).getHours();
          return hour >= 0 && hour <= 5;
        },
        bonus: 20,
        description: 'æ·±å¤œå·¥ä½œ'
      },
      {
        check: (e, c) => c.todayStats.completedCount >= 5,
        bonus: 10,
        description: 'è¿ç»­å®Œæˆå¤šä¸ªä»»åŠ¡'
      }
    ]
  },
  
  task_deleted: {
    base: 25,
    max: 50,
    bonuses: [
      {
        check: (e, c) => {
          const recentDeletes = c.todayStats.events
            .filter(ev => ev.type === 'task_deleted')
            .filter(ev => e.timestamp - ev.timestamp < 300000);  // 5åˆ†é’Ÿå†…
          return recentDeletes.length >= 2;
        },
        bonus: 20,
        description: 'è¿ç»­åˆ é™¤å¤šä¸ªä»»åŠ¡'
      }
    ]
  },
  
  // ... å…¶ä»–äº‹ä»¶ç±»å‹
};

function calculateProbability(
  event: AnnotationEvent,
  userContext: UserContext
): number {
  const weight = EVENT_WEIGHTS[event.type];
  if (!weight) return 0;
  
  let probability = weight.base;
  
  // åº”ç”¨æ‰€æœ‰æ»¡è¶³çš„åŠ æˆ
  weight.bonuses.forEach(bonus => {
    if (bonus.check(event, userContext)) {
      probability += bonus.bonus;
    }
  });
  
  // é™åˆ¶æœ€å¤§æ¦‚ç‡
  return Math.min(probability, weight.max);
}
```

---

## ğŸ¨ æ¸²æŸ“æ¶æ„

### SVG å½©çª—æ¸²æŸ“æµç¨‹

```
StainedGlass Component
    â”‚
    â”œâ”€â–º 1. åˆ›å»º SVG ç”»å¸ƒ
    â”‚     <svg viewBox="0 0 100 100">
    â”‚
    â”œâ”€â–º 2. å®šä¹‰æ»¤é•œå’Œæ¸å˜ (defs)
    â”‚     <defs>
    â”‚       <linearGradient id="grad1">...</linearGradient>
    â”‚       <filter id="glass">...</filter>
    â”‚     </defs>
    â”‚
    â”œâ”€â–º 3. æ¸²æŸ“èƒŒæ™¯ä¸»é¢˜
    â”‚     <image href={themeImage} opacity="0.3" />
    â”‚
    â”œâ”€â–º 4. æŒ‰ layer æ’åºæ¸²æŸ“ç¢ç‰‡
    â”‚     fragments.sort((a, b) => a.layer - b.layer)
    â”‚       .map(fragment => <FragmentShape />)
    â”‚
    â”œâ”€â–º 5. æ·»åŠ ç»ç’ƒæ•ˆæœå±‚
    â”‚     <rect filter="url(#glass)" opacity="0.1" />
    â”‚
    â””â”€â–º 6. æ·»åŠ è¾¹æ¡†å’Œè£…é¥°
          <rect stroke="rgba(255,255,255,0.3)" rx="12" />
```

### ç¢ç‰‡å½¢çŠ¶å®šä¹‰

```typescript
// components/fragments/shapeDefinitions.ts

export const SHAPE_PATHS = {
  spiral: (size: number) => `
    M ${size/2} ${size/10}
    Q ${size*0.9} ${size/2} ${size/2} ${size*0.9}
    Q ${size*0.1} ${size/2} ${size/2} ${size*0.3}
    Q ${size*0.7} ${size/2} ${size/2} ${size*0.7}
  `,
  
  arrow: (size: number) => `
    M ${size*0.2} ${size*0.4}
    L ${size*0.6} ${size*0.4}
    L ${size*0.6} ${size*0.2}
    L ${size*0.9} ${size*0.5}
    L ${size*0.6} ${size*0.8}
    L ${size*0.6} ${size*0.6}
    L ${size*0.2} ${size*0.6}
    Z
  `,
  
  spark: (size: number) => `
    M ${size/2} 0
    L ${size*0.6} ${size*0.35}
    L ${size} ${size/2}
    L ${size*0.6} ${size*0.65}
    L ${size/2} ${size}
    L ${size*0.4} ${size*0.65}
    L 0 ${size/2}
    L ${size*0.4} ${size*0.35}
    Z
  `,
  
  wave: (size: number) => `
    M 0 ${size*0.3}
    Q ${size*0.25} 0 ${size*0.5} ${size*0.3}
    Q ${size*0.75} ${size*0.6} ${size} ${size*0.3}
    L ${size} ${size*0.7}
    Q ${size*0.75} ${size} ${size*0.5} ${size*0.7}
    Q ${size*0.25} ${size*0.4} 0 ${size*0.7}
    Z
  `,
  
  crystal: (size: number) => `
    M ${size/2} 0
    L ${size*0.85} ${size*0.15}
    L ${size} ${size/2}
    L ${size*0.85} ${size*0.85}
    L ${size/2} ${size}
    L ${size*0.15} ${size*0.85}
    L 0 ${size/2}
    L ${size*0.15} ${size*0.15}
    Z
  `
};
```

---

## ğŸ“¡ API æ¥å£è§„èŒƒ

### 1. AI ç¢ç‰‡ç”Ÿæˆæ¥å£

```typescript
// api/ai.ts

/**
 * POST /api/ai/generate-fragments
 * 
 * è¯·æ±‚ä½“ï¼š
 */
interface GenerateFragmentsRequest {
  date: string;                    // YYYY-MM-DD
  activities: Array<{
    id: string;
    content: string;
    duration: number;              // åˆ†é’Ÿ
    timestamp: number;
    isMood: boolean;
    moodContent?: string;
  }>;
  context: {
    totalActivities: number;
    totalDuration: number;
    activeHours: number[];
    moodKeywords: string[];
  };
}

/**
 * å“åº”ä½“ï¼š
 */
interface GenerateFragmentsResponse {
  themeDescription: string;        // å¦‚"åœ¨æ˜Ÿç©ºä¸‹æ‰“ç›¹çš„çŒ«"
  themeName: string;               // å¦‚"æ˜Ÿç©ºçŒ«"
  fragments: Array<{
    activityId: string;
    shape: 'spiral' | 'arrow' | 'spark' | 'wave' | 'crystal';
    colorStart: string;            // HEX é¢œè‰²
    colorEnd: string;
    texture: 'heavy' | 'light' | 'flowing' | 'explosive' | 'solid';
    temperature: 'cool' | 'warm' | 'hot' | 'electric';
    reasoning: string;             // AI å†³ç­–ç†ç”±
  }>;
}
```

### 2. AI æ‰¹æ³¨ç”Ÿæˆæ¥å£

```typescript
/**
 * POST /api/ai/generate-annotation
 * 
 * è¯·æ±‚ä½“ï¼š
 */
interface GenerateAnnotationRequest {
  eventType: string;
  eventData: {
    activityContent?: string;
    duration?: number;
    timestamp: number;
    // ... å…¶ä»–äº‹ä»¶ç›¸å…³æ•°æ®
  };
  userContext: {
    todayActivities: number;
    todayDuration: number;
    currentHour: number;
    recentAnnotations: string[];    // ä»Šæ—¥å·²æ˜¾ç¤ºçš„æ‰¹æ³¨å†…å®¹
  };
  personality: {
    name: string;                   // "æ—¶é—´æ˜Ÿçƒè§‚å¯Ÿå‘˜"
    traits: string[];               // ["å‚²å¨‡", "æ¸©æš–", "è¯—æ„"]
  };
}

/**
 * å“åº”ä½“ï¼š
 */
interface GenerateAnnotationResponse {
  content: string;                 // æ‰¹æ³¨æ–‡æœ¬
  tone: 'playful' | 'concerned' | 'celebrating' | 'curious';
  displayDuration: number;         // å»ºè®®æ˜¾ç¤ºæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
  emoji?: string;                  // å¯é€‰çš„è¡¨æƒ…å‰ç¼€
}
```

### 3. AI å½±å­æ—¥è®°æ¥å£

```typescript
/**
 * POST /api/ai/generate-diary
 * 
 * è¯·æ±‚ä½“ï¼š
 */
interface GenerateDiaryRequest {
  date: string;
  fragments: Array<{
    shape: string;
    color: string;
    texture: string;
    activityContent: string;
    duration: number;
  }>;
  dayStats: {
    totalActivities: number;
    totalDuration: number;
    startHour: number;
    endHour: number;
    moodKeywords: string[];
  };
}

/**
 * å“åº”ä½“ï¼š
 */
interface GenerateDiaryResponse {
  greeting: string;                // ç§°å‘¼
  body: string;                    // ä¿¡ä»¶æ­£æ–‡
  highlights: string[];            // ä»Šæ—¥äº®ç‚¹ï¼ˆ3-5æ¡ï¼‰
  advice: string;                  // æ˜æ—¥å»ºè®®
  signature: string;               // ç½²å
  themeDescription: string;        // å½©çª—ä¸»é¢˜ï¼ˆåŒæ­¥ç”Ÿæˆï¼‰
  themeName: string;
}
```

---

## ğŸ”„ çŠ¶æ€åŒæ­¥ç­–ç•¥

### 1. LocalStorage æŒä¹…åŒ–

```typescript
// æ‰€æœ‰ Store ç»Ÿä¸€ä½¿ç”¨ Zustand persist

const useFragmentStore = create<FragmentState>()(
  persist(
    (set, get) => ({
      // ... state
    }),
    {
      name: 'fragment-storage',
      partialize: (state) => ({
        fragments: state.fragments,
        todayStats: state.todayStats
      })
    }
  )
);
```

### 2. è·¨ Store é€šä¿¡

```typescript
// ä½¿ç”¨ Zustand çš„ subscribe æˆ–äº‹ä»¶æ€»çº¿

// æ–¹å¼1ï¼šç›´æ¥åœ¨ action ä¸­è°ƒç”¨å…¶ä»– store
const useChatStore = create<ChatState>((set, get) => ({
  sendMessage: async (content) => {
    // ... åˆ›å»º message
    
    // è§¦å‘ç¢ç‰‡ç”Ÿæˆ
    const fragmentStore = useFragmentStore.getState();
    fragmentStore.addPending(newMessage.id);
    
    // è§¦å‘æ‰¹æ³¨æ£€æŸ¥
    const annotationStore = useAnnotationStore.getState();
    annotationStore.triggerAnnotation({
      type: 'activity_recorded',
      data: { content, timestamp: Date.now() }
    });
  }
}));

// æ–¹å¼2ï¼šäº‹ä»¶æ€»çº¿ï¼ˆæ›´è§£è€¦ï¼‰
const eventBus = new EventEmitter();

// å‘é€äº‹ä»¶
eventBus.emit('activity:recorded', { messageId, content });

// ç›‘å¬äº‹ä»¶
useEffect(() => {
  const handler = (data) => {
    // å¤„ç†äº‹ä»¶
  };
  eventBus.on('activity:recorded', handler);
  return () => eventBus.off('activity:recorded', handler);
}, []);
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ¸²æŸ“ä¼˜åŒ–

```typescript
// å½©çª—è™šæ‹Ÿæ»šåŠ¨
const VirtualizedGallery = () => {
  const { dailyGlasses } = useGalleryStore();
  
  return (
    <Virtuoso
      data={dailyGlasses}
      itemContent={(index, glass) => (
        <StainedGlassPreview 
          key={glass.id} 
          glass={glass}
          // ç¦»å±æ—¶æš‚åœåŠ¨ç”»
          isVisible={isInViewport(index)}
        />
      )}
    />
  );
};

// ç¢ç‰‡åŠ¨ç”»ä¼˜åŒ–
const FragmentShape = memo(({ fragment, layout }) => {
  return (
    <motion.g
      initial={{ scale: 0, opacity: 0 }}
      animate={{ scale: layout.scale, opacity: 1 }}
      transition={{ 
        type: 'spring',
        stiffness: 100,
        damping: 15,
        // ä½¿ç”¨ will-change ä¼˜åŒ–
        layoutId: fragment.id
      }}
      style={{ willChange: 'transform' }}
    >
      {/* SVG å†…å®¹ */}
    </motion.g>
  );
}, (prev, next) => {
  // è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ¸²æŸ“
  return prev.fragment.id === next.fragment.id;
});
```

### 2. AI è°ƒç”¨ä¼˜åŒ–

```typescript
// æ‰¹æ³¨è¯·æ±‚é˜²æŠ–
const debouncedAnnotation = debounce(
  (event) => aiAnnotator.generate(event),
  1000,  // 1ç§’å†…çš„äº‹ä»¶åˆå¹¶
  { maxWait: 5000 }  // æœ€å¤šç­‰å¾…5ç§’
);

// ç¢ç‰‡æ‰¹é‡ç”Ÿæˆï¼ˆè€Œéå®æ—¶ï¼‰
const scheduleBatchGeneration = () => {
  // å»¶è¿Ÿåˆ°ç©ºé—²æ—¶æ‰§è¡Œ
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
      fragmentStore.batchGenerate(today);
    }, { timeout: 5000 });
  } else {
    setTimeout(() => {
      fragmentStore.batchGenerate(today);
    }, 1000);
  }
};
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•é‡ç‚¹

```typescript
// services/__tests__/aiAnnotator.test.ts
describe('AI Annotator', () => {
  it('should respect cooldown period', () => {
    const state = { lastSpeakTime: Date.now() - 1000 }; // 1ç§’å‰
    expect(shouldSpeak(state)).toBe(false);
  });
  
  it('should respect daily limit', () => {
    const state = { todaySpeakCount: 5, dailyLimit: 5 };
    expect(shouldSpeak(state)).toBe(false);
  });
  
  it('should calculate probability correctly', () => {
    const event = { type: 'activity_completed', data: { duration: 180 } };
    const context = { todayStats: { completedCount: 3 } };
    const prob = calculateProbability(event, context);
    expect(prob).toBeGreaterThan(30);  // åŸºç¡€30% + åŠ æˆ
  });
});

// services/__tests__/glassGenerator.test.ts
describe('Glass Layout', () => {
  it('should place large fragments near center', () => {
    const fragments = [
      { id: '1', metadata: { duration: 180 } },
      { id: '2', metadata: { duration: 10 } }
    ];
    const layouts = generateDailyLayout(fragments, 'test');
    
    const largeLayout = layouts.find(l => l.fragmentId === '1');
    const distanceFromCenter = Math.sqrt(
      Math.pow(largeLayout.position.x - 0.5, 2) +
      Math.pow(largeLayout.position.y - 0.5, 2)
    );
    
    expect(distanceFromCenter).toBeLessThan(0.3);
  });
});
```

---

## ğŸ“š å‚è€ƒèµ„æº

- [Zustand Documentation](https://docs.pmnd.rs/zustand)
- [Framer Motion SVG](https://www.framer.com/motion/svg/)
- [SVG Path Tutorial](https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths)
- [Glassmorphism CSS](https://css.glass/)

---

*æ–‡æ¡£ç»“æŸ*
